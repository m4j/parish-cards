{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block page_content %}
<div class="container mt-4">
    <h2>{% if payment.guid %}Edit Payment{% else %}New Payment{% endif %}</h2>
    
    <form method="POST" class="needs-validation" novalidate>
        {{ form.csrf_token }}
        
        <!-- Base Payment Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Payment Details</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ wtf.form_field(form.payment.payor) }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ wtf.form_field(form.payment.date) }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ wtf.form_field(form.payment.method) }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ wtf.form_field(form.payment.identifier) }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ wtf.form_field(form.payment.amount) }}
                    </div>
                </div>
                
                <div class="mb-3">
                    {{ wtf.form_field(form.payment.comment, rows=3) }}
                </div>

                <!-- Add Sub-payment Buttons -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <button type="button" class="btn btn-primary w-100" onclick="addDuesSub()">Add Dues</button>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-primary w-100" onclick="addProsphoraSub()">Add Prosphora</button>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-primary w-100" onclick="addMiscSub()">Add Misc</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sub-payments Container -->
        <div class="card mb-4">
            <div class="card-body">
                <div id="dues-subs-container">
                    {% for subform in form.dues_subs %}
                    <div class="dues-sub-entry border rounded p-3 mb-3">
                        {% include 'payment/_dues_sub_form.html' %}
                    </div>
                    {% endfor %}
                </div>

                <div id="prosphora-subs-container">
                    {% for subform in form.prosphora_subs %}
                    <div class="prosphora-sub-entry border rounded p-3 mb-3">
                        {% include 'payment/_prosphora_sub_form.html' %}
                    </div>
                    {% endfor %}
                </div>

                <div id="misc-subs-container">
                    {% for subform in form.misc_subs %}
                    <div class="misc-sub-entry border rounded p-3 mb-3">
                        {% include 'payment/_misc_sub_form.html' %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <a href="{{ url_for('payment.multiple_subs') }}" class="btn btn-secondary">Cancel</a>
            {{ wtf.form_field(form.submit_btn, class="btn btn-primary") }}
        </div>
    </form>
</div>
{% endblock %} 

{% block scripts %}
{{ super() }}
<script>
function addSub(type) {
    const container = document.getElementById(`${type}-subs-container`);
    const entry = document.createElement('div');
    entry.className = `${type}-sub-entry border rounded p-3 mb-3`;
    
    // Get the current number of entries to determine the index
    const currentEntries = container.getElementsByClassName(`${type}-sub-entry`).length;
    
    // Create a new form entry with empty fields
    const formData = new FormData();
    formData.append('csrf_token', '{{ form.csrf_token.current_token }}');
    formData.append('_prefix', currentEntries.toString());
    
    fetch(`/payment/add_${type}_sub`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        entry.innerHTML = html;
        container.appendChild(entry);
    });
}

function addDuesSub() {
    addSub('dues');
}

function addProsphoraSub() {
    addSub('prosphora');
}

function addMiscSub() {
    addSub('misc');
}

function removeSub(button) {
    const container = button.parentElement;
    if (container) {
        container.remove();
    }
}
</script>
{% endblock %}